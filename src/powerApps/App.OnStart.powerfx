// âœ… App.OnStart (ìµœìƒë‹¨) - ì´ˆê¸° ì¤€ë¹„ í”Œë˜ê·¸ë§Œ
// name_label.TextëŠ” ì´ˆê¸°ì—” Blankì¼ ìˆ˜ ìˆì–´, ì—¬ê¸°ì„œ íŒ€ì„ í™•ì •í•˜ì§€ ì•ŠìŒ.
Set(varAppReady, true);


//// â”€â”€ 0. ë‚ ì§œÂ·ìƒíƒœ ê¸°ë³¸ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//Set(varSelProject, "");
Set(varYear,  Year(Today()));
//Set(varMonth, Month(Today()));
Set(varFirstDayOfMonth, Date(Year(Today()), Month(Today()), 1));
Set(varSelectedDate, Today());
//Set(FilterStatus,  "ì§„í–‰ì¤‘");
Set(FilterMode,    "All");
Set(currentView,   "ì—…ë¬´ì¼ì§€");
Set(SelectedItem , {});
Set(varFilterMode, "All");
Set(varToastMessage, "");  Set(varShowToast , false);
Set(varToastMessage2,"");  Set(varShowToast2, false);

Set(varSelectedAccount, "");

// íƒ€ì… ê³ ì •ìš© (ì—…ë¬´_ê³„ì •ì€ í…ìŠ¤íŠ¸ë‹ˆê¹Œ ë¬¸ìì—´ë¡œ)
Set(varSelAccount, "");

// ì´í›„ë¶€í„° Blank() ì‚¬ìš© ê°€ëŠ¥
Set(varSelAccount, Blank());

// í”„ë¡œì íŠ¸ ëª¨ë“œë„ ê°™ì´
Set(varProjectMode, "View");

Concurrent(
    /* 1) (êµ³ì´ í•„ìš” ì—†ë‹¤ë©´) ë³€ìˆ˜ë¥¼ ì—†ì• ë„ OK */
    Set(
        varCutoffDate,
        DateAdd(Today(), -400,TimeUnit.Days)
    ),

    /* 2) ë‚ ì§œë¥¼ ë‹¤ì‹œ ê³„ì‚°í•´ì„œ ì‚¬ìš© (ë…ë¦½) */
    ClearCollect(
        colMyTasks,
        ShowColumns(
            Filter(
                Task_DB,
                ì‘ì„±ì = varMyName,
                ì—…ë¬´_ì‹œì‘ì¼ì >= DateAdd(Today(), -400,TimeUnit.Days)
            ),
            ì—…ë¬´ì œëª©, ì—…ë¬´_ì‹œì‘ì¼ì, ìƒíƒœ, í”„ë¡œì íŠ¸ëª…
        )
    )
);



/* 2) ìƒíƒœ ì„ íƒ ì»¬ë ‰ì…˜ â€“ ê¸°ë³¸ ì „ë¶€ ì„ íƒ */
ClearCollect(
    colSelStatus,
    Table( {Value:"ì‹œì‘ì „"}, {Value:"ì§„í–‰ì¤‘"}, {Value:"ì™„ë£Œ"} )
);


/* â”€â”€â”€ ê¸°ì¡´ ì½”ë“œ ìœ„Â·ì•„ë˜ ì›í•˜ëŠ” ìœ„ì¹˜ì— ì¶”ê°€ â”€â”€â”€ */
Set(varShowPlanned,    false);   // ì‹œì‘ì „(Planned)   â†’ ê¸°ë³¸ OFF
Set(varShowInProgress, true );   // ì§„í–‰ì¤‘(InProgress)â†’ ê¸°ë³¸ ON
Set(varShowCompleted,  false);   // ì™„ë£Œ(Completed)   â†’ ê¸°ë³¸ OFF
 
//// â”€â”€ 1. ì‚¬ìš©ì ì •ë³´ (íšŒì‚¬ ë©”ì¼ì€ ëª¨ë‘ ì†Œë¬¸ì) â”€â”€â”€â”€â”€
Set(varMyEmail, Lower(User().Email));
 
/* 1-A) íŒ€ Â· ì´ë¦„ */
Set(
    varMyTeam,
    LookUp(
        UserInfo_DB,
        'e-mail' = varMyEmail,   // â† Email ì»¬ëŸ¼
        íŒ€                        // â† íŒ€ ì»¬ëŸ¼
    )
);
Set(
    varMyName,
    LookUp(
        UserInfo_DB,
        'e-mail' = varMyEmail,
        ì´ë¦„_í•œê¸€                  // â† í•œê¸€ ì´ë¦„ ì»¬ëŸ¼
    )
);
Set(varDisplayName, varMyName);

//// â”€â”€ ì‘ì—…_ë¶„ë¥˜(í‚¤ì›Œë“œ) ë§¤í•‘ í…Œì´ë¸” (ì—…ë¬´_ê³„ì •ë³„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// - Account: ì—…ë¬´_ê³„ì • ê°’ (colDailyTasksì˜ cì—…ë¬´_ê³„ì •ê³¼ ë™ì¼í•œ ê°’ì´ì–´ì•¼ í•¨)
// - Tag:     ë“œë¡­ë‹¤ìš´ì— ë³´ì—¬ì¤„ í‚¤ì›Œë“œ
// - Order:   0ì´ë©´ ë¯¸ì„ íƒ(í•­ìƒ ìµœìƒë‹¨), ë‚˜ë¨¸ì§€ëŠ” 1ë¶€í„°

ClearCollect(
    colWorkTagsMap,
    Table(
        // â”€â”€ ì œí’ˆê°œë°œ / ê¸°ìˆ ê°œë°œ / ì›ê°€ì ˆê° / ì„¤ê³„ë³€ê²½ : ì„¸íŠ¸ A â”€â”€
        {Account:"ì œí’ˆê°œë°œ", Tag:"â€” ë¯¸ì„ íƒ â€”", Order:0},
        {Account:"ì œí’ˆê°œë°œ", Tag:"ì¡°ë¦½(ì œì‘)", Order:1},
        {Account:"ì œí’ˆê°œë°œ", Tag:"ì„¤ê³„_Modeling", Order:2},
        {Account:"ì œí’ˆê°œë°œ", Tag:"ì„¤ê³„_Drawing", Order:3},
        {Account:"ì œí’ˆê°œë°œ", Tag:"ì‹œí—˜", Order:4},
        {Account:"ì œí’ˆê°œë°œ", Tag:"íšŒì˜", Order:5},
        {Account:"ì œí’ˆê°œë°œ", Tag:"ê¸°íš", Order:6},
        {Account:"ì œí’ˆê°œë°œ", Tag:"ê¸°íƒ€", Order:7},

        {Account:"ê¸°ìˆ ê°œë°œ", Tag:"â€” ë¯¸ì„ íƒ â€”", Order:0},
        {Account:"ê¸°ìˆ ê°œë°œ", Tag:"ì¡°ë¦½(ì œì‘)", Order:1},
        {Account:"ê¸°ìˆ ê°œë°œ", Tag:"ì„¤ê³„_Modeling", Order:2},
        {Account:"ê¸°ìˆ ê°œë°œ", Tag:"ì„¤ê³„_Drawing", Order:3},
        {Account:"ê¸°ìˆ ê°œë°œ", Tag:"ì‹œí—˜", Order:4},
        {Account:"ê¸°ìˆ ê°œë°œ", Tag:"íšŒì˜", Order:5},
        {Account:"ê¸°ìˆ ê°œë°œ", Tag:"ê¸°íš", Order:6},
        {Account:"ê¸°ìˆ ê°œë°œ", Tag:"ê¸°íƒ€", Order:7},

        {Account:"ì›ê°€ì ˆê°", Tag:"â€” ë¯¸ì„ íƒ â€”", Order:0},
        {Account:"ì›ê°€ì ˆê°", Tag:"ì¡°ë¦½(ì œì‘)", Order:1},
        {Account:"ì›ê°€ì ˆê°", Tag:"ì„¤ê³„_Modeling", Order:2},
        {Account:"ì›ê°€ì ˆê°", Tag:"ì„¤ê³„_Drawing", Order:3},
        {Account:"ì›ê°€ì ˆê°", Tag:"ì‹œí—˜", Order:4},
        {Account:"ì›ê°€ì ˆê°", Tag:"íšŒì˜", Order:5},
        {Account:"ì›ê°€ì ˆê°", Tag:"ê¸°íš", Order:6},
        {Account:"ì›ê°€ì ˆê°", Tag:"ê¸°íƒ€", Order:7},

        {Account:"ì„¤ê³„ë³€ê²½", Tag:"â€” ë¯¸ì„ íƒ â€”", Order:0},
        {Account:"ì„¤ê³„ë³€ê²½", Tag:"ì¡°ë¦½(ì œì‘)", Order:1},
        {Account:"ì„¤ê³„ë³€ê²½", Tag:"ì„¤ê³„_Modeling", Order:2},
        {Account:"ì„¤ê³„ë³€ê²½", Tag:"ì„¤ê³„_Drawing", Order:3},
        {Account:"ì„¤ê³„ë³€ê²½", Tag:"ì‹œí—˜", Order:4},
        {Account:"ì„¤ê³„ë³€ê²½", Tag:"íšŒì˜", Order:5},
        {Account:"ì„¤ê³„ë³€ê²½", Tag:"ê¸°íš", Order:6},
        {Account:"ì„¤ê³„ë³€ê²½", Tag:"ê¸°íƒ€", Order:7},

        // â”€â”€ TF : ì„¸íŠ¸ C â”€â”€
        {Account:"TF", Tag:"â€” ë¯¸ì„ íƒ â€”", Order:0},
        {Account:"TF", Tag:"íšŒì˜", Order:1},
        {Account:"TF", Tag:"ê¸°íš", Order:2},
        {Account:"TF", Tag:"ë¬¸ì„œ/ë³´ê³ ", Order:3},
        {Account:"TF", Tag:"ê¸°íƒ€", Order:4},

        // â”€â”€ êµìœ¡ : ì„¸íŠ¸ D â”€â”€
        {Account:"êµìœ¡", Tag:"â€” ë¯¸ì„ íƒ â€”", Order:0},
        {Account:"êµìœ¡", Tag:"êµìœ¡ìˆ˜ê°•", Order:1},
        {Account:"êµìœ¡", Tag:"êµìœ¡ìë£Œì‘ì„±", Order:2},
        {Account:"êµìœ¡", Tag:"ì‹œí—˜/í‰ê°€", Order:3},
        {Account:"êµìœ¡", Tag:"ê¸°íƒ€", Order:5},

        // â”€â”€ ê¸°íƒ€ì—…ë¬´ : ì„¸íŠ¸ E â”€â”€
        {Account:"ê¸°íƒ€ì—…ë¬´", Tag:"â€” ë¯¸ì„ íƒ â€”", Order:0},
        {Account:"ê¸°íƒ€ì—…ë¬´", Tag:"íšŒì˜", Order:1},
        {Account:"ê¸°íƒ€ì—…ë¬´", Tag:"ë¬¸ì„œ/ë³´ê³ ", Order:2},
        {Account:"ê¸°íƒ€ì—…ë¬´", Tag:"í–‰ì •", Order:3},
        {Account:"ê¸°íƒ€ì—…ë¬´", Tag:"ì§€ì›ì—…ë¬´", Order:4},
        {Account:"ê¸°íƒ€ì—…ë¬´", Tag:"ê¸°íƒ€", Order:5},

        // â”€â”€ ì—°ì°¨(ë°˜ì°¨) : ì„¸íŠ¸ B â”€â”€
        {Account:"ì—°ì°¨(ë°˜ì°¨)", Tag:"â€” ë¯¸ì„ íƒ â€”", Order:0},
        {Account:"ì—°ì°¨(ë°˜ì°¨)", Tag:"ì—°ì°¨", Order:1},
        {Account:"ì—°ì°¨(ë°˜ì°¨)", Tag:"ì˜¤ì „ë°˜ì°¨", Order:2},
        {Account:"ì—°ì°¨(ë°˜ì°¨)", Tag:"ì˜¤í›„ë°˜ì°¨", Order:3}
    )
);
 
 
// â”€â”€ ìµœê·¼ 365ì¼ ê¸°ì¤€ì¼ (ì´ë¯¸ varCutoffDate ë§Œë“¤ê³  ìˆìœ¼ë‹ˆ ê·¸ê±¸ ì¨ë„ ë¨)
Set(varCutoffDate, DateAdd(Today(), -400, TimeUnit.Days));

// (ê¶Œì¥) ìµœì‹  ë°ì´í„° ë³´ì¥
Refresh(Daily_DB);

//// â”€â”€ 2. ìµœê·¼ 365ì¼ íŒ€ ë°ì´í„° â–¶ colDaily_365_Team â”€â”€â”€â”€â”€
ClearCollect(
    colDaily_365_Team,
    ShowColumns(
        Filter(
            Daily_DB,
            ì‘ì„±ì¼ì >= varCutoffDate &&
            íŒ€ = varMyTeam
        ),
        ID,
        ì‘ì„±ì¼ì,
        ì‘ì„±ì,
        íŒ€,
        í”„ë¡œì íŠ¸ëª…,
        ì—…ë¬´ì œëª©,
        ì‘ì—…ì‹œê°„,
        ìƒíƒœ,
        í”¼ë“œë°±
    )
);

//// â”€â”€ 2-B. ìµœê·¼ 365ì¼ ì „ì²´ ë°ì´í„° â–¶ colDaily_365_All â”€â”€â”€â”€â”€
ClearCollect(
    colDaily_365_All,
    ShowColumns(
        Filter(
            Daily_DB,
            ì‘ì„±ì¼ì >= varCutoffDate
        ),
        ID,
        ì‘ì„±ì¼ì,
        ì‘ì„±ì,
        íŒ€,
        í”„ë¡œì íŠ¸ëª…,
        ì—…ë¬´ì œëª©,
        ì‘ì—…ì‹œê°„,
        ìƒíƒœ,
        í”¼ë“œë°±
    )
);

//// â”€â”€ 3. í”„ë¡œì íŠ¸ ëª©ë¡ (ì •ê·œí™” + Value í†µì¼ + Blank ì œê±°) â”€â”€â”€â”€â”€

// âœ… App.OnStart - í”„ë¡œì íŠ¸ ëª©ë¡ ìºì‹œ ìƒì„± (Value ì»¬ëŸ¼ í…Œì´ë¸”)
// - colDaily_365_Teamì—ì„œ í”„ë¡œì íŠ¸ëª…(ì›ë³¸ ì»¬ëŸ¼)ì„ Trim í›„ ì¤‘ë³µ ì œê±°
// - ë¹ˆ ê°’ ì œì™¸
// - Value ê¸°ì¤€ ì •ë ¬

// âœ… App.OnStart - í”„ë¡œì íŠ¸ ëª©ë¡ ìºì‹œ ìƒì„± (Value ì»¬ëŸ¼ í…Œì´ë¸”)
// - colDaily_365_Teamì—ì„œ í”„ë¡œì íŠ¸ëª…(ì›ë³¸ ì»¬ëŸ¼)ì„ Trim í›„ ì¤‘ë³µ ì œê±°
// - ë¹ˆ ê°’ ì œì™¸
// - Value ê¸°ì¤€ ì •ë ¬

// âœ… App.OnStart - í”„ë¡œì íŠ¸ ëª©ë¡ ìºì‹œ ìƒì„± (Value ì»¬ëŸ¼ í…Œì´ë¸”)
// - colDaily_365_Teamì—ì„œ í”„ë¡œì íŠ¸ëª…(ì›ë³¸ ì»¬ëŸ¼)ì„ Trim í›„ ì¤‘ë³µ ì œê±°
// - ë¹ˆ ê°’ ì œì™¸
// - Value ê¸°ì¤€ ì •ë ¬

ClearCollect(
    colProjectList,
    SortByColumns(
        Filter(
            Distinct(
                AddColumns(
                    colDaily_365_Team,
                    ProjNorm,
                    Trim(OData__xd504__xb85c__xc81d__xd2b8__xba0) // ì›ë³¸ í”„ë¡œì íŠ¸ëª…
                ),
                ProjNorm
            ),
            !IsBlank(Value)   // âœ… ë„¤ í™˜ê²½ì—ì„œëŠ” Valueê°€ ê²°ê³¼ ì»¬ëŸ¼
        ),
        "Value",
        SortOrder.Ascending
    )
);




ClearCollect(
    colAllProjects,
    SortByColumns(
        RenameColumns(
            Filter(
                Distinct(
                    AddColumns(colDaily_365_All, ProjNorm, Trim(OData__xd504__xb85c__xc81d__xd2b8__xba0)),
                    ProjNorm
                ),
                !IsBlank(Value)
            ),
           Value,
            Value
        ),
        "Value",
        SortOrder.Ascending
    )
);

// ê¸°ë³¸ ì„ íƒ: íŒ€ë³„ ì „ì²´ ì„ íƒ
Clear(colSelProjects);
Collect(colSelProjects, colProjectList.Value);


Set(varShowDetail, false);   // íŒì—… í‘œì‹œ ì—¬ë¶€
//Set(varSelID,     Blank());  // ì„ íƒëœ Daily_DB PK(ID)

// ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ìºì‹±
Set(
    varMyInfo,
    LookUp(UserInfo_DB, 'ì´ë¦„_í•œê¸€' = name_label.Text)
);
Set(varMyRole, varMyInfo.'ì§ê¸‰2');   // Choice íƒ€ì…ì´ë©´ .Value í•„ìˆ˜
Set(varMyDivision, varMyInfo.'ë¶€ë¬¸');
//Set(varMyTeam, varMyInfo.'íŒ€');
Set(varViewMode, "íŒ€ë³„");   // ğŸ”¸ ìƒˆ ì „ì—­ ë³€ìˆ˜ (ê¸°ë³¸ê°’: íŒ€ë³„)

// ì—…ë¬´_ê³„ì • ì„ íƒ ì‹œ ì‘ì—…_êµ¬ë¶„ ë³´ì´ê²Œ í•˜ê¸°
Set(varSelTaskType, "");   // íƒ€ì…(í…ìŠ¤íŠ¸) ê³ ì •ìš© 1íšŒ ì´ˆê¸°í™”
Set(varSelTaskType, Blank());

Set(varSelProject, "");    // (ê¶Œì¥) ì´ê²ƒë„ ë™ì¼í•˜ê²Œ íƒ€ì… ê³ ì •
Set(varSelProject, Blank());


// ========================================
// â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ëŒ€ì‹œë³´ë“œ í™”ë©´App.OnStart  (1íšŒì„± ì¤€ë¹„ ì˜ì—­) â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
// ========================================

// 0) ì•± ì¤€ë¹„ í”Œë˜ê·¸ (ì˜µì…˜)
Set(varAppReady, false);

// 1) ìˆ¨ê¹€ íŒ€ ëª©ë¡(í•„ìš”í•œ ë§Œí¼ ì¶”ê°€)
Set(
    varHiddenTeams,
    ["ì—°êµ¬ê´€ë¦¬íŒ€2", "ì—”ì§„ê°œë°œíŒ€2", "ì œí’ˆê°œë°œDXíŒ€"]
);

// 2) íŒ”ë ˆíŠ¸(ëŒ€ë¶„ë¥˜ ì°¨íŠ¸/legend ìƒ‰ ìœ ì§€ìš©) âœ…
Set(
    varAccPalette,
    [
        RGBA(27, 94, 32, 1),
        RGBA(30, 136, 229, 1),
        RGBA(239, 108, 0, 1),
        RGBA(56, 142, 60, 1),
        RGBA(0, 137, 123, 1),
        RGBA(142, 36, 170, 1),
        RGBA(124, 179, 66, 1),
        RGBA(3, 155, 229, 1),
        RGBA(251, 192, 45, 1),
        RGBA(144, 164, 174, 1),
        RGBA(189, 189, 189, 1),
        RGBA(224, 224, 224, 1)
    ]
);

// 3) ë¡œê·¸ì¸ ì‚¬ìš©ì ì´ë¦„(ê¸°ë³¸ê°’)
Set(varLoginName, Coalesce(User().FullName, ""));

// 4) ì‚¬ìš©ì ì •ë³´ 1íšŒ ì¡°íšŒ
Set(
    varMe,
    LookUp(UserInfo_DB, ì´ë¦„_í•œê¸€ = varLoginName)
);

// (ì„ íƒ) ë§Œì•½ FullNameì´ DBì™€ ì•ˆ ë§ëŠ” ê²½ìš°ê°€ ë§ìœ¼ë©´,
// ì´ë©”ì¼ ì»¬ëŸ¼ì´ UserInfo_DBì— ìˆì„ ë•Œë§Œ ì•„ë˜ ë°±ì—…ì„ ì“°ì„¸ìš”.
// If(IsBlank(varMe), Set(varMe, LookUp(UserInfo_DB, ì´ë©”ì¼ = User().Email)));

Set(varMyRole, varMe.ì§ê¸‰2);
Set(varMyTeam, varMe.íŒ€);
Set(varMyDivision, varMe.ë¶€ë¬¸);

// 5) ddMemberìš© ë¦¬ìŠ¤íŠ¸ 2ì¢… ìƒì„±(1íšŒ)
//    - colMemberList: íŒ€ì¥ ì „ìš©(íŒ€ì›)
//    - colTeamList: ë¶€ë¬¸ì¥/ì†Œì¥ ì „ìš©(íŒ€)
ClearCollect(colMemberList, {Label:"ì „ì²´"});
ClearCollect(colTeamList, {Label:"ì „ì²´"});

// íŒ€ì¥(ë˜ëŠ” íŒ€ì›)ì¼ ë•Œ: íŒ€ì› ë¦¬ìŠ¤íŠ¸ ì¤€ë¹„
If(
    varMyRole = "íŒ€ì¥",
    ForAll(
        Filter(UserInfo_DB, íŒ€ = varMyTeam) As U,
        Collect(colMemberList, {Label: U.ì´ë¦„_í•œê¸€})
    )
);

// ë¶€ë¬¸ì¥/ì†Œì¥ì¼ ë•Œ: íŒ€ ë¦¬ìŠ¤íŠ¸ ì¤€ë¹„
If(
    varMyRole = "ë¶€ë¬¸ì¥" || varMyRole = "ì†Œì¥",
    With(
        {
            t: If(
                varMyRole = "ì†Œì¥",
                UserInfo_DB,
                Filter(UserInfo_DB, ë¶€ë¬¸ = varMyDivision)
            )
        },
        ForAll(
            t As U,
            With(
                { teamName: Trim(Coalesce(U.íŒ€, "")) },
                If(
                    !IsBlank(teamName) &&
                    teamName <> "ì „ì²´" &&
                    !(teamName in varHiddenTeams) &&
                    IsBlank(LookUp(colTeamList, Label = teamName)),
                    Collect(colTeamList, {Label: teamName})
                )
            )
        )
    )
);

Set(varAppReady, true);
